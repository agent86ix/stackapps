<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 
<html>
<head>
<title>Stinking Badges!</title>

<link type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/cupertino/jquery-ui.css" rel="Stylesheet" />	
<link type="text/css" href="../common/style.css" rel="Stylesheet" />
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
<script type="text/javascript" src="../js/api.js"></script>
<script type="text/javascript" src="../js/common.js"></script>
<script type="text/javascript" src="../js/jquery.iecors.js"></script>

<script type="text/javascript" src="../js/jquery.cookies.min.js"></script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-26396490-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<script type="text/javascript" language="javascript">

var user_site = "stackoverflow";
var user_id = 0;

var api = StackExchangeAPI;

var question_filter = '!3wg4GB8fZ7Dv.7sqF';
var answer_filter = '!mV2oEnRAeF';

var vote_list_common_args = {pagesize:10, order:'desc', sort:'votes' };

function on_vote_list_success(json, output_id) {
	if(!('items' in json)) {
		$('#'+output_id).html("An error occurred...");
		return;
	}
	
	output_html = "";
	var count = 0;
	
	for(var item_id in json['items']) {
		var item = json['items'][item_id];
		var item_path = '/q/'+item['question_id'];
		if('answer_id' in item) {
			item_path = '/a/'+item['answer_id'];
		}
		count++;
		output_html = output_html + 
			"<span class=\"post-score\">"+item['score']+
			'</span> <a target="_blank" href="'+api.site_list[user_site].site_url+
			item_path+'">'+item['title']+"</a><br>\n";
	}
	if(count) {
		$('#'+output_id).html(output_html);
	} else {
		$('#'+output_id).html("None of your posts are close to this badge :(");
	}
	
}


function refresh_all() {


	api.call("/questions/", 
		$.extend({site: user_site,  max: '-3', filter:'!3wg4GB8fZ7Dv.7sqF'}, vote_list_common_args),
		function (json) { on_vote_list_success(json, "question_list_bronze") });

	api.call("/answers/", 
		$.extend({site: user_site, min: '7', max: '9', filter:'!)qk0x1x-Z8ryVmFbK.yk'}, vote_list_common_args),
		function (json) { on_vote_list_success(json, "question_list_bronze") });

		
}

function reset_output() {
	$("#account").html("(No account information loaded yet)");
	
	$("#answer_list_gold").html('<img src="../common/load.gif">');
}

function clear_output() {

}

function on_auth_success(json) {
	
	if(!('items' in json) || json.items.length == 0) {
		$("#account").html('<span style="color:red">You don\'t have an account on this site!</span>');
		clear_output();
		return;
	}
	
	var user = json.items[0];
	
	user_id = user['user_id'];
	$("#account").html('<a target="_blank" href="'+api.site_list[user_site].site_url+'/users/'+user_id+'">'+
		user['display_name'] + "</a>");
	
	refresh_all();

	
}

function on_auth_fail(request, status, error) {
	clear_output();
	$("#account").html('<span style="color:red">Your access token is invalid or has been revoked!  Try getting a new one with the "Reset Access Token" button.</span>');
	
}

function on_error(request, status, error) {
	alert("An error has occurred!");
}

$(document).ready(function() {
	var client_id = 74;
	var args = {key:encodeURI('tD7YpcY3WuQGUz*f47P21g((')};
	
	try {
		var stored_user_site = $.cookies.get('badges_user_site');
		if(stored_user_site != null) user_site = stored_user_site;
	} catch (err) {
	
	}
	
	$("#siteselect").change(function (e) {
		user_site = $("#siteselect").val();
		$.cookies.set('badges_user_site', $("#siteselect").val());
		
		api.abort_queue();
		reset_output();
		api.auth(user_site, on_auth_success, on_auth_fail);
	});
	
	
	$("#refresh").click(function (e) {
		api.abort_queue();
		reset_output();
		api.auth(user_site, on_auth_success, on_auth_fail);
		e.preventDefault();
	}).button();

	$("#token_reset").click(function (e) {
		api.abort_queue();
		api.reset_access_token(client_id);
		e.preventDefault();
	}).button();

	$("#revoke").click(function (e) {
		clear_output();
		api.abort_queue();
		api.revoke_access();
		alert("Your authorization has been revoked.");
		e.preventDefault();
	});

	
	api.init(client_id, args);
	api.populate_site_select("#siteselect", user_site);
	api.auth(user_site, on_auth_success, on_auth_fail);
	
});
</script>

</head>
<body>
<div class="shadowbox">
<h1>StinkingBadges</h1>

<i>Badges?  We don't need no <a href="http://www.youtube.com/watch?v=TFwprS_L6tg">stinking badges!</a></i>

<p>Check my progress on: <select id="siteselect"></select></p>
<p>
Your account on this site: <span id="account">(No account information loaded yet)</span>   
<a href="#" class="small-button" id="refresh">Refresh</a>   
<a href="#" class="small-button" id="token_reset">Reset Access Token</a>
</p>


<p></p>



<p>This application uses an "access token" to access your account information 
on the Stack Exchange network.  If you'd like, you can <a href="#" id="revoke">revoke</a> 
this permission.</p>
<div id="pagefooter"></div>
</div>
</body>
</html>
